---
title: "NCAA Men's College Basketball Analysis"
author: "Jake Whalen"
date: "March 22, 2020"
output: 
    html_document:
      code_folding: hide
      number_sections: yes
      toc: yes
      toc_float: yes
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE,
                      message = FALSE,
                      fig.width = 8, fig.height = 3)
```

```{r packages, include=FALSE}
library(vroom)
library(tidyverse)
library(magrittr)
library(ggthemes)
library(gridExtra)
library(janitor)
```

```{r helpers, include=FALSE}
my_theme <- 
    theme_solarized() +
    theme(panel.background = element_rect(color='black'))
```

# Purpose

The purpose of this project is to explore the Mens NCAA March Madness data for insight into what gives teams a winning advantage.
This will be done in a series of steps.
The first will be to explore the data and create some nice visuals to help better understand what each file contains.
The second will be to work through a series of questions and use the data to come up with an answer to each.
The final step is to take the information learned from the first two steps and attempt to predict winners and losers.
At the end of this project I hope to have found some interesting insights into what winning teams do well, answered the questions I have come up with for the data, and built a working model to predict game outcomes.

# Data

The data for this project was downloaded from the [Google Cloud & NCAA March Madness Analytics](https://www.kaggle.com/c/march-madness-analytics-2020/data) Kaggle competition.
The project will focus on the data from the NCAA Men's league.
The list of names below are the data files included for this analysis.
The data goes back to 1985.
The reason for cutting off at 1985 is because this was the first year the tournament expanded to 64 teams, similar to today but without the 4 play-in teams.

```{r data, cache=TRUE}
folder <- 'C:/Users/Jake/Documents/Projects/UVA-CBB/data/MDataFiles_Stage1'
files <- list.files(folder)
dfs <- list()

for (f in files){
    df.name <- str_replace(f, '.csv', '')
    dfs[[df.name]] <- vroom(file.path(folder, f))
}
files
```

In addition to the files above there are play-by-play records since 2015.
These files contain indic=vidual records for every event takig place during the season.
There is potential for the data to not be 100% accurate in these files so they will be used sparingly as a secondary data source.

```{r pbp, cache=TRUE}
# folder <- 'C:/Users/Jake/Documents/Projects/UVA-CBB/data'
# files <- list.files(folder, pattern = "MEvents")
# pbp <- list()
# 
# for (f in files){
#     df.name <- str_replace(f, '.csv', '')
#     pbp[[df.name]] <- vroom(file.path(folder, f))
# }
# files
```


# Exploratory Data Analysis (EDA)

Some of the data files supplied contain useful metadata to go along with some of the other more detailed files.
These files include Cities, MGameCities, Conferences, MNCAATourneySeedRoundSlots, MSeasons, MTeamConferences, MNCAATourneySlots, and MTeamSpellings.
The data from these files may be incorporated into the analysis later on but ther is nothing to discover from these files alone.

## Teams

The __MTeams__ dataframe contains the TeamID, team name, and first/last season the team was active in.
Schools with an active team still competing in todays league have the year 2020 in the _LastD1Season_ column.

There have been `r nrow(dfs$MTeams)` D1 teams that have played at least one seson since `r min(dfs$MTeams$FirstD1Season)` (first season recorded in data).
In `r min(dfs$MTeams$FirstD1Season)` there were `r nrow(filter(dfs$MTeams, FirstD1Season == min(dfs$MTeams$FirstD1Season)))` active D1 men's teams.
There were `r nrow(filter(dfs$MTeams, LastD1Season == 2020))` active teams in the most recent college basketball season (2019-2020).
The chart below shows the growth over time in the number of men's D1 basketball teams.
The number of new teams added (85) to the D1 landscape, since 1985, have far surpassed the number of teams that have folded (12).

```{r}
left_join(dfs$MTeams %>%
              group_by(Season = FirstD1Season) %>% summarise(First = n()),
          dfs$MTeams %>%
              group_by(Season = LastD1Season) %>% summarise(Last = n()),
          by = 'Season') %>% 
    mutate(Last = ifelse(is.na(Last), 0, Last),
           fCS = cumsum(First),
           lCS = cumsum((Last)),
           current = fCS - lag(lCS),
           current = ifelse(is.na(current), First, current)) %>% 
    ggplot(aes(x=Season, y=current)) +
    geom_line() +
    geom_point(color = 'maroon') +
    labs(title = "Growth of NCAA Men's Div 1",
         y = 'Number of Teams', x = 'Season') +
    my_theme
```

## NCAA March Madness

There are a handful of data sets included that are specific to the NCAA MArch Madness tournament.

### Tournament Seeding

Selection Sunday is the Sunday on the final weekend of the regular season when conference tournaments wrap up.
The name comes from the fact that on that day the 64 (68 including play-ins) teams are selected on live TV to compete in March Madness.
While some teams are waiting to find out if they will be invited, a majority already know with almost near certainty that they will be given an invite.
Those teams who know they are in are mostly interested to see what their seed is and who their opponents will be.

Seeding in the tournament is very important.
It is widely considered that the higher the seed the better chance you have at making the Final Four and winning the National Championship.
The lowest seed to ever win the championship was Villanova at the 8 spot.
This isn't to say seeds below an 8 should be counted out, but history is not on their side.

#### Seed Matchup Performance

The graphic below shows the winnig percentage amongst seed matchups.
The seeds denoted on the y-axis are the winners while the seeds across the x-axis are the losers.
The diagonal (equal seeded matchups) were removed from this chart since there was no comparison (1 seed has a 100% win rate against 1 seeds with a 100% losing rate at the same time).
A blank indicates the two seeds have never matched up before in the tournament.
When viewing this chart it is important to remind yourself that not all of these matchups are as common as others.
For instance a 1 vs 16 and a 8 vs 9 are guaranteed to be played four times every single tournament because those are first round games.

A few quick takeaways from the graphic below:

* 1 Seeds:
    + Have lost to a 16 only one time in the history of the tournament.
    + As expected, have a greater than 50% winning percentage against all other seeds.
    + Have never faced a 14 or 15 seed due to these lower seeds never advancing far enough (Elite 8).
    + Struggle with the 11 seeds, only posting a 57% winning percentage.
* Being a 2 seed doesn't look as good as it sounds.
    + 0 wins over 5 and 9 seeds.
    + An abysmal 29% winning percentage over 8 seeds.
* In recent memory the 5 vs 12 is a common upset pick in many brackets however the 12 seed only holds a 36% winning percentage in this matchup.


```{r, fig.height=6}
df.seed.results <-
    dfs$MNCAATourneyCompactResults %>% 
    select(Season, DayNum, WTeamID, LTeamID) %>% 
    left_join(., 
              dfs$MNCAATourneySeeds %>% rename(WTeamID = TeamID, WSeed = Seed),
              by = c('Season', 'WTeamID')) %>% 
    left_join(., 
              dfs$MNCAATourneySeeds %>% rename(LTeamID = TeamID, LSeed = Seed),
              by = c('Season', 'LTeamID')) %>% 
    mutate(WSeed = str_replace(WSeed, 'a', ''),
           WSeed = str_replace(WSeed, 'b', ''),
           LSeed = str_replace(LSeed, 'a', ''),
           LSeed = str_replace(LSeed, 'b', ''),
           WReg = substr(WSeed, 1, 1),
           LReg = substr(LSeed, 1, 1),
           W_L_Regions = paste(WReg, LReg, sep = "/"),
           WSeed = as.numeric(substr(WSeed, 2, 3)),
           LSeed = as.numeric(substr(LSeed, 2, 3)))

df.wvl.seed <-
    df.seed.results %>%
    group_by(WSeed, LSeed) %>% 
    summarise(WSeedWins = n())

df.wvl.seed %>% 
    left_join(., 
              df.wvl.seed %>% 
                  rename(LSeed = WSeed, WSeed = LSeed,
                         LSeedWins = WSeedWins),
              by = c('WSeed', 'LSeed')) %>%
    filter(WSeed != LSeed) %>% 
    mutate(LSeedWins = ifelse(is.na(LSeedWins), 0, LSeedWins),
           WSeedWinPct = WSeedWins / (WSeedWins + LSeedWins)) %>%
    ggplot(aes(x=LSeed, y=WSeed, fill=WSeedWinPct)) +
    geom_tile() +
    geom_text(aes(label = round(WSeedWinPct, 2))) +
    geom_segment(aes(x=0.5, y=0.5, xend=16.5, yend=16.5)) +
    geom_hline(yintercept = 0.5:16.5) +
    geom_vline(xintercept = 0.5:16.5) +
    scale_y_continuous(trans = "reverse", breaks = 1:16, expand = c(0,0)) +
    scale_x_continuous(position = "top", breaks = 1:16, expand = c(0,0)) +
    scale_fill_gradient2(low = 'red', mid='grey',
                         high='green', midpoint = 0.5) +
    my_theme +
    theme(axis.ticks = element_blank(),
          legend.position = 'bottom',
          panel.grid.major = element_blank()) +
    labs(x = 'Losing Team Seed', y = 'Winning Team Seed')
```

#### Individual Team Tournament History

The graphs below take a look at the frequency with which teams made the tournament over the past 35 seasons (left) and their average seed when making the tournament (right).
These graphics confirm what most who follow college basketball already knew, the blue bloods (Duke, UNC, UK, KU) are nicknamed that for a reason.
The consistently make the tournament and they are consistently given high seeds.


```{r, fig.height=4}
team.seeds <-
    dfs$MNCAATourneySeeds %>% 
    mutate(Seed = str_replace(Seed, 'a', ''),
           Seed = str_replace(Seed, 'b', ''),
           Region = substr(Seed, 1, 1),
           Seed = as.numeric(substr(Seed, 2, 3))) %>% 
    left_join(., 
              dfs$MTeams %>% select(TeamID, TeamName))

team.seeds.summ <-
    team.seeds %>% 
    group_by(TeamName) %>% 
    summarise(Appearances = n(), AvgSeed = mean(Seed),
              High = max(Seed), Low = min(Seed)) %>% 
    ungroup()

#Teams history of being seeded
p1 <- team.seeds.summ %>% 
    ungroup() %>% 
    mutate(rank = rank(-Appearances, ties.method = 'min')) %>% 
    filter(rank <= 10) %>% 
    ggplot(aes(x = Appearances, y=reorder(TeamName, Appearances))) +
    geom_bar(stat = 'identity', fill = 'lightblue', color = 'black') +
    geom_text(aes(x=Appearances/2, label = Appearances)) +
    my_theme +
    labs(y = 'Team', x = 'Tournament Appearances (Max 35)')

#Teams average seed
p2 <- team.seeds.summ %>% 
    mutate(rank = rank(AvgSeed, ties.method = 'min')) %>% 
    filter(rank <= 10) %>% 
    ggplot(aes(x = AvgSeed, y=reorder(TeamName, -AvgSeed))) +
    geom_bar(stat = 'identity', fill = 'lightblue', color = 'black') +
    geom_text(aes(x=AvgSeed/2, label = sprintf("%s (%s)", round(AvgSeed, 2), Appearances))) +
    my_theme +
    labs(y = 'Team', x = 'Average Seed (Appearances)')

grid.arrange(p1, p2, ncol=2)
```

#### Average Seed vs March Madness Winning Percentage

The graph below plots each teams average tournamnet seed (x-axis) against their tournamnet winning percentage all-time (y-axis).
The graph illustrates what most would expect, higher seeds (lower on x-axis) win more games in the tournament (higher on the y-axis).
You see the blue bloods in the top left corner as expected.
Loyola-Chicago seems to be a bit of an outlier.
This is primarily due to their Final Four run in 2018 as an 11 seed.
Prior to that they had been to the tournament one time as a 4 seed in 1985.
On the other end there is a team like TCU who has consistently underperformed there seeding.
With three trips to the tournament as a 4, 5, and 6 seed they have posted a sub 30% winning percentage.

```{r, fig.height=6}
#Avg Seed vs Winning %
#filter(dfs$MNCAATourneySeeds, TeamID == filter(dfs$MTeams, TeamName == 'Cleveland St')$TeamID)
dfs$MNCAATourneyCompactResults %>%
    group_by(TeamID = WTeamID) %>%
    summarise(Wins = n()) %>% 
    left_join(.,
              dfs$MNCAATourneyCompactResults %>%
                  group_by(TeamID = LTeamID) %>%
                  summarise(Losses = n()),
              by = 'TeamID') %>% 
    left_join(., 
              dfs$MTeams %>% select(TeamID, TeamName),
              by = 'TeamID') %>% 
    mutate(WinPct = Wins / (Wins + Losses)) %>% 
    select(TeamName, WinPct) %>% 
    left_join(., team.seeds.summ, by = 'TeamName') %>% 
    ggplot(aes(x=AvgSeed, y=WinPct)) +
    geom_text(aes(label = TeamName, color = TeamName),
              size = 3, show.legend = F) +
    my_theme +
    labs(y = 'March Madness Winning Percentage', x = 'Average Seed') +
    scale_y_continuous(labels = scales::percent)
```

#### Conference Matchup Performance

Only includes conferences that existed in the 2019-20 season.

```{r, fig.height=8}
#Conf vs conf
cnf_v_cnf <-
    dfs$MNCAATourneyCompactResults %>% 
    select(Season, WTeamID, LTeamID) %>% 
    left_join(.,
              dfs$MTeamConferences %>%
                  rename(WTeamID = TeamID, WConf = ConfAbbrev)) %>% 
    left_join(.,
              dfs$MTeamConferences %>%
                  rename(LTeamID = TeamID, LConf = ConfAbbrev)) %>% 
    group_by(WConf, LConf) %>% 
    count()

keep_conf <-
    dfs$MTeamConferences %>% 
    filter(Season == 2020) %>%
    group_by(ConfAbbrev) %>% 
    count() %>% 
    select(Conf = ConfAbbrev) %>% 
    .[[1]]

cnf_v_cnf %<>%
    filter(WConf %in% keep_conf, LConf %in% keep_conf)

cnf_v_cnf %>% 
    full_join(.,
              cnf_v_cnf %>% 
                  rename(WConf = LConf,
                         LConf = WConf,
                         n_L = n)) %>%
    filter(WConf != LConf) %>% 
    mutate(n = ifelse(is.na(n), 0, n),
           n_L = ifelse(is.na(n_L), 0, n_L),
           WinPct = n / (n + n_L)) %>% 
    ggplot(aes(y=WConf, x=LConf, fill=WinPct)) +
    geom_tile() +
    geom_text(aes(label = round(WinPct, 2)), size=2, angle = 35) +
    geom_segment(aes(x=0.5, y=32.5, xend=32.5, yend=0.5)) +
    geom_hline(yintercept = 1.5:32.5) +
    geom_vline(xintercept = 1.5:32.5) +
    scale_x_discrete(position = 'top', expand = c(0,0)) +
    scale_y_discrete(limits = rev(unique(cnf_v_cnf$WConf)), expand = c(0,0)) +
    scale_fill_gradient2(low = 'red', mid='grey',
                         high='green', midpoint = 0.5) +
    my_theme +
    theme(axis.text.x = element_text(angle = 45, hjust = -.1),
          panel.grid.major = element_blank(),
          legend.position = 'bottom') +
    labs(x='Losing Team Conference', y='Winning Team Conference')
```


## Conference Tourneys

MConferenceTourneyGames

## Coaches

MTeamCoaches

## Rankings

MMasseyOrdinals

# Asking the Data Questions

* Coaching changes
* Similarity between reg season and playoffs
* Distance from home in tourney
* Best region to be in to win it all?
* Do regular season matchups determine MM outcome?